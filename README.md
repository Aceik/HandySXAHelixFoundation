# Siteore Speedy
Sitecore Speedy - Use best practice page load techniques to achieve excellent Page Speed scores.

SXA Version

Description

This is a Sitecore Helix module that incorporates best practice layout HTML structures in order in an attempt to maximiuse the scores achievable in Google Page Speed Insights.

Page Speed is an important metric of a websites performance and has a big impact on SEO and a sites Google ranking. 

Optimising your site for great page speed scores could involve:

1) Server Side caching  (impact the Time to First Byte (TTFB) metric)
2) Image optimiisation (Loseless compression), Image Lazy Loading, Responsive images
3) Critical CSS and Defered external asset files
4) HTTP2

Read more here ...

This module addresses Critical CSS and Deferred asset loading, which is perhaps the hardest one to get right. 

Pre-Requisuits 
1) Node.JS

Installation - From Helix Source - Assumes Unicorn is in use

Instructions
1) Incorporate the module into your Foundation layer and VS solution
2) Publish project to your running IIS site or deploy via CI/CD
3) Run a unicorn sync for the module Foundation.Speedy
	a) Templates will be installed here: /sitecore/templates/Foundation/Speedy/
	b) A global settings file is installed here:  /sitecore/system/Settings/Foundation/Speedy/Speedy Global Settings
	c) A new SXA Layout will be installed here: /sitecore/layout/Layouts/Foundation/Speedy/MVC/MVC Layout Page Speed


4) Update your the desired SXA template to include the new base _SpeedyPage base template.
   a) You may choose to add Speedy techniques to only the homepage in which case you could:
		i) Locate the Home tempalte that was generated by SXA, it should be located in /sitecore/templates/Project/Site/Home and make it inherit from:  /sitecore/templates/Foundation/Speedy/_SpeedyPage
		ii) To make all pages in your SXA site use Speedy you need to locate the Page template (within you SXA generated site templates) /sitecore/templates/Project/Site/Page and make it inherit from _SpeedyPage. 

5) Which ever page you now choose to use Speedy on, navigate to that item:
   i) Make a new version of the item, so that you can roll back if needed.
   ii) Presentation > Details > Final Layout :  Change the layout to "Layouts/Foundation/Speedy/MVC/MVC Layout Page Speed"
   iii) Save and publish the item

6) Critical Generation 

In order to grab the critical CSS for the viewport we use an NPM tool.  https://www.npmjs.com/package/critical

Included in this repository are two scripts, one that can be hosted and one that can be run on a local development environment by developers. 

a) Production Mode - Critical Generation
   
   For production the process of generation critical can be automated. As your application is likely public facing it will likely have a public URL that can be used by another application to ready the HTML/CSS and generate that critical for any page on your website.
   We achieve this via a OnSave event in Sitecore that will restore the Critical HTML on the item when that Item is saved.

   The OnSave event is patched in via:  App_Config\Include\Speedy\Foundation\Foundation.Speedy.Events.config

   On save this will call an external API that will run "npm critical" and pass back the critical CSS in a JSON object. 

   API Example: https://nodeapicritical.azurewebsites.net/critical/?url=https%3A%2F%2Fwww.australia.com%2Fen&width=1900&height=1800

   This is a hosted node script that is availabe in this repostory in a seperate repository -> https://github.com/TomTyack/CriticalCSSAPI.git
   It can be easily hosted on a free tier of Azure Webapps.

   The Hosted Node API uses https://www.browserless.io/ which is essentially a service that will run the chromium npm tool.  This is a little difficult to host on Azure at present altough has been raised as a feature request in the future. https://www.browserless.io/ has limits on the free APIs so if you need a lot of Critical generation calls you may need to purchase a higher tier.
   
b) Development Mode - Critical Generation

   For development mode you can find the critical generation node script in /scripts/Critical.js

   Instructions:
   i) on the command line run "npm install" in the folder \src\Foundation\Speedy\code\ of this repository once checked out.
   ii) Update the setting file \src\Foundation\Speedy\code\Critical.json
      - itemid = Set the Sitecore item ID of the page in Sitecore
	  - host = Set this to your local development environment URL
	  - width = The viewport width of the Critical CSS you require
	  - height = The viewport height of the Critical CSS you require
   iii) From the same folder (\src\Foundation\Speedy\code) on the command line run "node ./Scripts/Critical.js main"
   iiii) Now login to Sitecore to verify the Critcal CSS field has been populated.  The field with the title "Generated Critical HTML" under the Critical section.



Heading: Complex Issues

In reality there is nothing simple about getting Critical and Javascript to play together. 

This process will take some trial and error, the aim of which is to present the user with an experience that is so quick that they don't notice and strange behaviour at all.

Strange behaviour usually includes flashing or mutating elements (in the blink of eye) as the deferred page load assets are loaded into the DOM.  This is due to the fact 
that these assets are delayed and once they are loaded they each impact the DOM in turn.

So how do we handle this.

a) Hide components / features that require complex Javascript interactions until the Javascript library is ready.  After which we reshow the component. 
b) Provide a loading splash if a is all to hard. 


Font Replacement

It seems that critical npm has some issues with font paths. The critical node script in this repository does have a feature to fix this.



Sitecore Module Settings


Node Settings  (Standalone Developer Mode)


Node Settings (Hosted Azure Node Application)







